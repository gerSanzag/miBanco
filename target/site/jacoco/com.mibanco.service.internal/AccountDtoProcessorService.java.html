<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AccountDtoProcessorService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">miBanco</a> &gt; <a href="index.source.html" class="el_package">com.mibanco.service.internal</a> &gt; <span class="el_source">AccountDtoProcessorService.java</span></div><h1>AccountDtoProcessorService.java</h1><pre class="source lang-java linenums">package com.mibanco.service.internal;

import com.mibanco.dto.AccountDTO;
import com.mibanco.dto.ClientDTO;
import com.mibanco.dto.mappers.AccountMapper;
import com.mibanco.dto.mappers.ClientMapper;
import com.mibanco.service.ClientService;
import com.mibanco.service.TransactionOperationsService;

import java.math.BigDecimal;
import java.util.Map;
import java.util.Optional;

/**
 * Specialized service for processing AccountDTO creation
 * Applies the Single Responsibility Principle (SRP)
 * Responsible solely for transforming raw data into valid AccountDTOs
 * and processing account-related operations
 */
public class AccountDtoProcessorService {
    
    private final ClientService clientService;
    
<span class="nc" id="L24">    public AccountDtoProcessorService(ClientService clientService) {</span>
<span class="nc" id="L25">        this.clientService = clientService;</span>
<span class="nc" id="L26">    }</span>
    
    /**
     * Processes raw data and creates a valid AccountDTO
     * @param rawData Map with account data
     * @return Optional with processed AccountDTO or empty if there are errors
     */
    public Optional&lt;AccountDTO&gt; processAccountDto(Map&lt;String, String&gt; rawData) {
<span class="nc" id="L34">        return Optional.of(rawData)</span>
<span class="nc" id="L35">            .flatMap(this::getHolderById)</span>
<span class="nc" id="L36">            .flatMap(holder -&gt; buildAccountDTO(rawData, holder));</span>
    }
    
    /**
     * Processes initial deposit and prepares account with balance
     * @param createdAccount The account already created
     * @param initialAmount The initial deposit amount
     * @param transactionService Service for processing transactions
     * @return Optional with account prepared with balance or empty if validation fails
     */
    public Optional&lt;AccountDTO&gt; processInitialDeposit(AccountDTO createdAccount, 
                                                      BigDecimal initialAmount, 
                                                      TransactionOperationsService transactionService) {
        // Convert DTO to entity to get ID
<span class="nc" id="L50">        ClientMapper clientMapper = new ClientMapper();</span>
<span class="nc" id="L51">        AccountMapper accountMapper = new AccountMapper(clientMapper);</span>
        
<span class="nc" id="L53">        return accountMapper.toEntityDirect(createdAccount)</span>
<span class="nc" id="L54">            .flatMap(accountEntity -&gt; {</span>
<span class="nc" id="L55">                Long accountId = accountEntity.getId();</span>
<span class="nc" id="L56">                return transactionService.deposit(</span>
<span class="nc" id="L57">                    Optional.of(accountId),</span>
<span class="nc" id="L58">                    Optional.of(initialAmount),</span>
<span class="nc" id="L59">                    Optional.of(&quot;Initial opening deposit&quot;)</span>
                )
<span class="nc" id="L61">                .map(transaction -&gt; updateAccountWithBalance(createdAccount, initialAmount));</span>
            })
<span class="nc" id="L63">            .or(() -&gt; Optional.empty());</span>
    }
    
    /**
     * Updates account with initial balance (without persistence)
     * @param account The account to update
     * @param balance The initial balance
     * @return The updated account
     */
    public AccountDTO updateAccountWithBalance(AccountDTO account, BigDecimal balance) {
<span class="nc" id="L73">        return account.toBuilder()</span>
<span class="nc" id="L74">            .initialBalance(balance)</span>
<span class="nc" id="L75">            .balance(balance)</span>
<span class="nc" id="L76">            .build();</span>
    }
    
    /**
     * Extracts holder ID and gets client in a single functional method
     */
    private Optional&lt;ClientDTO&gt; getHolderById(Map&lt;String, String&gt; rawData) {
<span class="nc" id="L83">        return Optional.ofNullable(rawData.get(&quot;holderId&quot;))</span>
<span class="nc" id="L84">            .map(Long::parseLong)</span>
<span class="nc" id="L85">            .flatMap(holderId -&gt; clientService.getClientById(Optional.of(holderId)));</span>
    }
    
    /**
     * Builds the AccountDTO from raw data and holder
     */
    private Optional&lt;AccountDTO&gt; buildAccountDTO(Map&lt;String, String&gt; rawData, ClientDTO holder) {
        try {
<span class="nc" id="L93">            AccountDTO.AccountDTOBuilder builder = AccountDTO.builder()</span>
<span class="nc" id="L94">                .holder(holder);</span>

            // Apply functional transformations
<span class="nc" id="L97">            Optional.ofNullable(rawData.get(&quot;type&quot;))</span>
<span class="nc" id="L98">                .map(com.mibanco.model.enums.AccountType::valueOf)</span>
<span class="nc" id="L99">                .ifPresent(builder::type);</span>

<span class="nc" id="L101">            Optional.ofNullable(rawData.get(&quot;creationDate&quot;))</span>
<span class="nc" id="L102">                .map(java.time.LocalDateTime::parse)</span>
<span class="nc" id="L103">                .ifPresent(builder::creationDate);</span>

            // Active status by default
<span class="nc" id="L106">            Optional.ofNullable(rawData.get(&quot;active&quot;))</span>
<span class="nc" id="L107">                .map(Boolean::parseBoolean)</span>
<span class="nc" id="L108">                .or(() -&gt; Optional.of(true))</span>
<span class="nc" id="L109">                .ifPresent(builder::active);</span>

<span class="nc" id="L111">            return Optional.of(builder.build());</span>
<span class="nc" id="L112">        } catch (Exception e) {</span>
<span class="nc" id="L113">            return Optional.empty();</span>
        }
    }
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>